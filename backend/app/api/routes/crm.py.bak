from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from app.db.session import get_db_session
from app.models.company import Company
from app.models.contact import Contact
from app.models.deal import Deal
from app.models.user import UserRole
from app.schemas.company import CompanyCreate, CompanyUpdate, CompanyOut
from app.schemas.contact import ContactCreate, ContactUpdate, ContactOut
from app.schemas.deal import DealCreate, DealUpdate, DealOut
from app.api.deps import get_current_user, require_role

router = APIRouter(prefix="/crm", tags=["crm"])


# ==================== COMPANIES ====================

@router.get("/companies", response_model=List[CompanyOut])
def list_companies(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db_session)
):
    """List all companies"""
    companies = db.query(Company).offset(skip).limit(limit).all()
    return companies


@router.get("/companies/{company_id}", response_model=CompanyOut)
def get_company(
    company_id: int,
    db: Session = Depends(get_db_session)
):
    """Get a specific company by ID"""
    company = db.query(Company).filter(Company.id == company_id).first()
    if not company:
        raise HTTPException(status_code=404, detail="Company not found")
    return company


@router.post("/companies", response_model=CompanyOut)
def create_company(
    company_data: CompanyCreate,
    db: Session = Depends(get_db_session)
):
    """Create a new company"""
    company = Company(**company_data.model_dump())
    db.add(company)
    db.commit()
    db.refresh(company)
    return company


@router.put("/companies/{company_id}", response_model=CompanyOut)
def update_company(
    company_id: int,
    company_data: CompanyUpdate,
    db: Session = Depends(get_db_session)
):
    """Update an existing company"""
    company = db.query(Company).filter(Company.id == company_id).first()
    if not company:
        raise HTTPException(status_code=404, detail="Company not found")
    
    update_data = company_data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(company, key, value)
    
    db.commit()
    db.refresh(company)
    return company


@router.delete("/companies/{company_id}")
def delete_company(
    company_id: int,
    db: Session = Depends(get_db_session)
):
    """Delete a company"""
    company = db.query(Company).filter(Company.id == company_id).first()
    if not company:
        raise HTTPException(status_code=404, detail="Company not found")
    
    db.delete(company)
    db.commit()
    return {"ok": True, "message": "Company deleted successfully"}


# ==================== CONTACTS ====================

@router.get("/contacts", response_model=List[ContactOut])
def list_contacts(
    skip: int = 0,
    limit: int = 100,
    company_id: int = None,
    db: Session = Depends(get_db_session),
    user=Depends(get_current_user)
):
    """List all contacts, optionally filtered by company"""
    query = db.query(Contact)
    if company_id:
        query = query.filter(Contact.company_id == company_id)
    contacts = query.offset(skip).limit(limit).all()
    return contacts


@router.get("/contacts/{contact_id}", response_model=ContactOut)
def get_contact(
    contact_id: int,
    db: Session = Depends(get_db_session),
    user=Depends(get_current_user)
):
    """Get a specific contact by ID"""
    contact = db.query(Contact).filter(Contact.id == contact_id).first()
    if not contact:
        raise HTTPException(status_code=404, detail="Contact not found")
    return contact


@router.post("/contacts", response_model=ContactOut)
def create_contact(
    contact_data: ContactCreate,
    db: Session = Depends(get_db_session),
    user=Depends(require_role(UserRole.editor, UserRole.admin))
):
    """Create a new contact (requires editor or admin role)"""
    contact = Contact(**contact_data.model_dump())
    db.add(contact)
    db.commit()
    db.refresh(contact)
    return contact


@router.put("/contacts/{contact_id}", response_model=ContactOut)
def update_contact(
    contact_id: int,
    contact_data: ContactUpdate,
    db: Session = Depends(get_db_session),
    user=Depends(require_role(UserRole.editor, UserRole.admin))
):
    """Update an existing contact (requires editor or admin role)"""
    contact = db.query(Contact).filter(Contact.id == contact_id).first()
    if not contact:
        raise HTTPException(status_code=404, detail="Contact not found")
    
    update_data = contact_data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(contact, key, value)
    
    db.commit()
    db.refresh(contact)
    return contact


@router.delete("/contacts/{contact_id}")
def delete_contact(
    contact_id: int,
    db: Session = Depends(get_db_session),
    user=Depends(require_role(UserRole.admin))
):
    """Delete a contact (requires admin role only)"""
    contact = db.query(Contact).filter(Contact.id == contact_id).first()
    if not contact:
        raise HTTPException(status_code=404, detail="Contact not found")
    
    db.delete(contact)
    db.commit()
    return {"ok": True, "message": "Contact deleted successfully"}


# ==================== DEALS ====================

@router.get("/deals", response_model=List[DealOut])
def list_deals(
    skip: int = 0,
    limit: int = 100,
    company_id: int = None,
    stage: str = None,
    db: Session = Depends(get_db_session),
    user=Depends(get_current_user)
):
    """List all deals, optionally filtered by company and stage"""
    query = db.query(Deal)
    if company_id:
        query = query.filter(Deal.company_id == company_id)
    if stage:
        query = query.filter(Deal.stage == stage)
    deals = query.offset(skip).limit(limit).all()
    return deals


@router.get("/deals/{deal_id}", response_model=DealOut)
def get_deal(
    deal_id: int,
    db: Session = Depends(get_db_session),
    user=Depends(get_current_user)
):
    """Get a specific deal by ID"""
    deal = db.query(Deal).filter(Deal.id == deal_id).first()
    if not deal:
        raise HTTPException(status_code=404, detail="Deal not found")
    return deal


@router.post("/deals", response_model=DealOut)
def create_deal(
    deal_data: DealCreate,
    db: Session = Depends(get_db_session),
    user=Depends(require_role(UserRole.editor, UserRole.admin))
):
    """Create a new deal (requires editor or admin role)"""
    deal = Deal(**deal_data.model_dump())
    db.add(deal)
    db.commit()
    db.refresh(deal)
    return deal


@router.put("/deals/{deal_id}", response_model=DealOut)
def update_deal(
    deal_id: int,
    deal_data: DealUpdate,
    db: Session = Depends(get_db_session),
    user=Depends(require_role(UserRole.editor, UserRole.admin))
):
    """Update an existing deal (requires editor or admin role)"""
    deal = db.query(Deal).filter(Deal.id == deal_id).first()
    if not deal:
        raise HTTPException(status_code=404, detail="Deal not found")
    
    update_data = deal_data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(deal, key, value)
    
    db.commit()
    db.refresh(deal)
    return deal


@router.delete("/deals/{deal_id}")
def delete_deal(
    deal_id: int,
    db: Session = Depends(get_db_session),
    user=Depends(require_role(UserRole.admin))
):
    """Delete a deal (requires admin role only)"""
    deal = db.query(Deal).filter(Deal.id == deal_id).first()
    if not deal:
        raise HTTPException(status_code=404, detail="Deal not found")
    
    db.delete(deal)
    db.commit()
    return {"ok": True, "message": "Deal deleted successfully"}


# ==================== STATS ====================

@router.get("/stats")
def get_crm_stats(
    db: Session = Depends(get_db_session),
    user=Depends(get_current_user)
):
    """Get CRM statistics"""
    total_companies = db.query(Company).count()
    total_contacts = db.query(Contact).count()
    total_deals = db.query(Deal).count()
    
    # Deal pipeline value
    pipeline_value = db.query(Deal).filter(Deal.stage.in_(['lead', 'qualified', 'proposal', 'negotiation'])).all()
    total_pipeline = sum(deal.value or 0 for deal in pipeline_value)
    
    # Won deals value
    won_deals = db.query(Deal).filter(Deal.stage == 'won').all()
    total_won = sum(deal.value or 0 for deal in won_deals)
    
    return {
        "totalCompanies": total_companies,
        "totalContacts": total_contacts,
        "totalDeals": total_deals,
        "pipelineValue": total_pipeline,
        "wonValue": total_won,
        "conversionRate": (len(won_deals) / total_deals * 100) if total_deals > 0 else 0
    }

